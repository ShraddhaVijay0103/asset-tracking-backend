name: Build and Deploy API to IIS

on:
  push:
    branches: [ main ]

jobs:
  build-deploy:
    runs-on: self-hosted

    env:
      BUILD_DIR: C:\gh_build
      IIS_DIR: C:\publish

    steps:

    - name: Checkout code
      uses: actions/checkout@v4

    # ✅ Runner already has dotnet — just verify
    - name: Check dotnet
      run: dotnet --info

    - name: Restore
      run: dotnet restore src/AssetTracking.Rfid.Api/AssetTracking.Rfid.Api.csproj

    - name: Build
      run: dotnet build src/AssetTracking.Rfid.Api/AssetTracking.Rfid.Api.csproj --configuration Release --no-restore

    - name: Publish
      run: dotnet publish src/AssetTracking.Rfid.Api/AssetTracking.Rfid.Api.csproj -c Release -o $env:BUILD_DIR

    # ✅ Safest IIS unlock method
    - name: Put app offline
      shell: powershell
      run: |
        New-Item "$env:IIS_DIR\app_offline.htm" -ItemType File -Force
        Start-Sleep -Seconds 10

    # ✅ Kill dotnet process to unlock DLL
    - name: Kill dotnet processes
      shell: powershell
      run: |
        Get-Process dotnet -ErrorAction SilentlyContinue | Stop-Process -Force

    # ✅ Copy files
    - name: Copy files to IIS
      run: robocopy $env:BUILD_DIR $env:IIS_DIR /MIR /R:2 /W:3

    # ✅ Bring app back online
    - name: Remove offline file
      shell: powershell
      run: |
        Remove-Item "$env:IIS_DIR\app_offline.htm" -ErrorAction SilentlyContinue

    - name: Done
      run: echo "Deployment complete"

